<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:validation="http://www.mulesoft.org/schema/mule/validation" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/validation http://www.mulesoft.org/schema/mule/validation/current/mule-validation.xsd">
	<sub-flow name="post-signin-handler-subflow" doc:id="6fd4e785-6f29-4a3e-979b-ba895a56d3a0" >
		<ee:transform doc:name="Save payload" doc:id="28338945-1edc-4314-bbf8-77234f4c44de" >
			<ee:message />
			<ee:variables >
				<ee:set-variable variableName="password" ><![CDATA[%dw 2.0
output application/java

---
payload.password]]></ee:set-variable>
				<ee:set-variable variableName="emailAddress" ><![CDATA[%dw 2.0
output application/java
---
payload.email_address]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<validation:is-email doc:name="Input email validation" doc:id="fd8155e0-26ab-4994-9fe3-bb977de655bd" email="#[vars.emailAddress]" message="DDBAUTH-S-00001" >
			<error-mapping targetType="APP:EXCEPTION_HANDLING" />
		</validation:is-email>
		<flow-ref doc:name="Ref to aws_dd:get-user-password-flow" doc:id="df675c27-6a8d-4e3e-b81b-9f4b2b7d61c6" name="aws_dd:get-user-password-flow"/>
		<validation:is-not-null doc:name="Is user exists" doc:id="202815ae-b3e5-441f-80a2-8fdc91a18141" value="#[vars.receivedPassword]" message="DDBAUTH-S-00007">
			<error-mapping targetType="APP:EXCEPTION_HANDLING" />
		</validation:is-not-null>
		<ee:transform doc:name="Compare paswords" doc:id="d3181007-c9a5-447c-980c-876899bf33b2" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="isPasswordMatch" ><![CDATA[%dw 2.0
output application/java

import comparePasswords from dw::auth
---
comparePasswords(vars.receivedPassword, vars.password)]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<validation:is-true doc:name="Password validation" doc:id="bcd07e0e-a529-421c-9d93-075d60368424" message="DDBAUTH-S-00008" expression="#[vars.isPasswordMatch]">
			<error-mapping targetType="APP:EXCEPTION_HANDLING" />
		</validation:is-true>
		<flow-ref doc:name="Ref to jwt-generator-orchestrator-subflow" doc:id="5171a549-f1c5-4cb2-9d85-2c6e2ff114ae" name="jwt-generator-orchestrator-subflow" />
		<ee:transform doc:name="Set new rt" doc:id="fefdf9fc-3b25-4827-9edb-8eee132067bc">
			<ee:message />
			<ee:variables>
				<ee:set-variable variableName="newRefreshToken"><![CDATA[%dw 2.0
output application/java
---
vars.tokens.refreshToken]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="Ref to aws_dd:update_user_rt-flow" doc:id="31f8a2ae-e935-4f95-a355-36fe424dbd13" name="aws_dd:update_user_rt-flow"/>
		<validation:is-true doc:name="Refresh token validation" doc:id="9ae5691f-57e1-4e3f-9f22-3fd8c1b32f3f" expression="#[vars.refreshToken == vars.newRefreshToken]" message="DDBAUTH-S-00009">
			<error-mapping targetType="APP:EXCEPTION_HANDLING" />
		</validation:is-true>
		<ee:transform doc:name="Set response" doc:id="efaf0a80-5a33-4a5a-bfd0-7bd8aa17e083" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json

---
{
	access_token: "Bearer " ++ vars.tokens.accessToken,
	refresh_token: "Bearer " ++ vars.tokens.refreshToken
}

]]></ee:set-payload>
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/java
---
200]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
	</sub-flow>
</mule>
