<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:validation="http://www.mulesoft.org/schema/mule/validation" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/validation http://www.mulesoft.org/schema/mule/validation/current/mule-validation.xsd">
	<sub-flow name="post-signout-handler-subflow" doc:id="50ee9f6e-0c7b-4e51-bf4b-a0c97f8b9797" >
		<ee:transform doc:name="Save user email address" doc:id="2432fd4e-5021-419e-ba97-0412b902d375" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="emailAddress" ><![CDATA[%dw 2.0
output application/java
---
payload.email_address]]></ee:set-variable>
				<ee:set-variable variableName="refreshToken" ><![CDATA[%dw 2.0
output application/java
---
payload.refresh_token]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="Ref to aws_dd:get-refresh-token-data-subflow" doc:id="50937f93-1ebc-4298-8469-fe77e30f542c" name="aws_dd:get-refresh-token-data-subflow"/>
		<validation:is-true doc:name="Is user exists in DB" doc:id="42059679-b913-4757-97a9-27ff65688827" message="DDBAUTH-S-00003" expression="#[vars.isUserExists]">
			<error-mapping targetType="APP:EXCEPTION_HANDLING" />
		</validation:is-true>
		<validation:is-true doc:name="Is token equal" doc:id="18f5596f-9c3f-4946-9738-2c47613f1ac0" expression="#[vars.receivedRefreshToken == vars.refreshToken]" message="DDBAUTH-S-00007">
			<error-mapping targetType="APP:EXCEPTION_HANDLING" />
		</validation:is-true>
		<ee:transform doc:name="Set new rt" doc:id="97562cb0-f03e-4ccd-b56e-51872a4feb32" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="newRefreshToken" ><![CDATA[%dw 2.0
output application/java
---
""]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="Ref to aws_dd:update_user_rt-subflow" doc:id="b9abd095-f778-48c8-92d3-1f88c40da496" name="aws_dd:update_user_rt-subflow"/>
		<validation:is-true doc:name="Refresh token validation" doc:id="408e2975-60c3-44bd-8aef-9398ad2c182e" expression="#[vars.refreshToken == vars.newRefreshToken]" message="DDBAUTH-S-00004">
			<error-mapping targetType="APP:EXCEPTION_HANDLING" />
		</validation:is-true>
		<ee:transform doc:name="Set response" doc:id="9cc6b191-d85d-466d-8a03-c9d1f10b0e77" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
null]]></ee:set-payload>
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/java
---
204]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
	</sub-flow>
</mule>
